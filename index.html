<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Guardian | Audit & Vibe Coding</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/gh/Nexus-Studio-CEO/CSOP@v0.1.0/src/csop.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        nexus: {
                            50: '#f0f9ff',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                            dark: '#0f172a',
                            surface: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Fira+Code:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'Fira Code', monospace; }
        
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .gradient-border {
            position: relative;
            border-radius: 1rem;
            background: rgba(30, 41, 59, 0.5);
            padding: 1px;
        }
        .gradient-border::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 1rem;
            padding: 1.5px;
            background: linear-gradient(45deg, #0ea5e9, transparent, #6366f1);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .view-transition { transition: all 0.3s ease-in-out; }
        .hidden { display: none; }
        
        .provider-card, .repo-card {
            transition: all 0.3s;
        }
        .provider-card:hover, .repo-card:hover {
            transform: translateY(-2px);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-disconnected { background: #6b7280; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out; }
        .toast-exit { animation: slideOut 0.3s ease-out; }

        .log-entry {
            border-left: 3px solid transparent;
        }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .log-entry.info { border-left-color: #3b82f6; }
    </style>
</head>
<body class="bg-nexus-dark text-slate-200 min-h-screen flex flex-col selection:bg-nexus-500/30">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <nav class="glass sticky top-0 z-40 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 group cursor-pointer" onclick="app.showView('home')">
                <div class="bg-nexus-600 p-2 rounded-xl shadow-lg shadow-nexus-600/20 group-hover:scale-110 transition-transform">
                    <i data-lucide="shield-check" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-extrabold text-xl tracking-tighter uppercase italic">Nexus <span class="text-nexus-500">Guardian</span></span>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="app.showView('projects')" class="text-sm font-medium hover:text-nexus-500 transition-colors px-3 py-2">Projets</button>
                <button onclick="app.showView('logs')" class="text-sm font-medium hover:text-nexus-500 transition-colors px-3 py-2">Logs</button>
                <button onclick="app.showView('config')" class="p-2 hover:bg-white/5 rounded-full transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- VIEW: HOME -->
        <section id="view-home" class="view-transition space-y-12 py-12">
            <div class="text-center space-y-4">
                <h1 class="text-5xl font-black text-white tracking-tight">Bienvenue dans le <span class="text-nexus-500 italic">Nexus</span>.</h1>
                <p class="text-slate-400 text-lg max-w-2xl mx-auto">Choisissez votre workflow. Analyse de code existant ou création instantanée pilotée par l'intention.</p>
                <div class="flex items-center justify-center gap-2 text-xs text-slate-600">
                    <i data-lucide="database" class="w-3 h-3"></i>
                    <span>Powered by CSOP Protocol</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-3xl font-black text-nexus-500" id="stat-projects">0</div>
                    <div class="text-xs text-slate-500 uppercase">Projets</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-3xl font-black text-blue-500" id="stat-analyses">0</div>
                    <div class="text-xs text-slate-500 uppercase">Analyses</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-3xl font-black text-green-500" id="stat-providers">0</div>
                    <div class="text-xs text-slate-500 uppercase">Providers</div>
                </div>
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-3xl font-black text-purple-500" id="stat-logs">0</div>
                    <div class="text-xs text-slate-500 uppercase">Logs</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                <div onclick="app.showView('audit')" class="gradient-border group cursor-pointer transition-all hover:scale-[1.02]">
                    <div class="p-8 space-y-6">
                        <div class="w-12 h-12 bg-blue-500/10 rounded-xl flex items-center justify-center text-blue-400 group-hover:bg-blue-500/20">
                            <i data-lucide="file-search" class="w-6 h-6"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white">Mode Audit & Correction</h2>
                        <p class="text-slate-400 text-sm leading-relaxed">Sélectionnez un de vos repos GitHub. L'IA identifie les failles et crée automatiquement une PR avec les corrections.</p>
                        <div class="flex items-center gap-2 text-blue-400 font-bold text-sm uppercase tracking-wider">
                            Commencer l'audit <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div onclick="app.showView('vibe')" class="gradient-border group cursor-pointer transition-all hover:scale-[1.02]">
                    <div class="p-8 space-y-6">
                        <div class="w-12 h-12 bg-nexus-500/10 rounded-xl flex items-center justify-center text-nexus-400 group-hover:bg-nexus-500/20">
                            <i data-lucide="wand-2" class="w-6 h-6"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white">Vibe Coding (Génération)</h2>
                        <p class="text-slate-400 text-sm leading-relaxed">Décrivez votre projet. L'IA génère le code complet ET le push directement sur votre GitHub.</p>
                        <div class="flex items-center gap-2 text-nexus-400 font-bold text-sm uppercase tracking-wider">
                            Lancer une génération <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: AUDIT -->
        <section id="view-audit" class="view-transition hidden space-y-6">
            <button onclick="app.showView('home')" class="flex items-center gap-2 text-slate-500 hover:text-white text-sm transition-colors">
                <i data-lucide="chevron-left" class="w-4 h-4"></i> Retour à l'accueil
            </button>
            
            <div class="glass p-8 rounded-3xl space-y-6 border border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i data-lucide="git-pull-request" class="text-blue-400"></i> Analyser un Repository
                </h2>
                
                <button onclick="app.fetchUserRepos()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    Charger mes Repositories
                </button>

                <div id="repos-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Profondeur d'Analyse</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="app.setAuditDepth('skeleton')" id="depth-skeleton" class="depth-btn p-3 rounded-xl border border-white/10 text-sm text-left hover:bg-white/5 transition-all">
                                <div class="font-bold">Squelette</div>
                                <div class="text-[10px] text-slate-500">Architecture & Imports</div>
                            </button>
                            <button onclick="app.setAuditDepth('full')" id="depth-full" class="depth-btn p-3 rounded-xl border border-nexus-500 bg-nexus-500/10 text-sm text-left transition-all">
                                <div class="font-bold">Intégrale</div>
                                <div class="text-[10px] text-slate-500">Code ligne par ligne</div>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Persona IA</label>
                        <select id="audit-persona" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-sm">
                            <option value="architect">Lead Architecte (Standard)</option>
                            <option value="security">Expert Sécurité (Paranoïaque)</option>
                            <option value="mentor">Mentor Dev (Pédagogique)</option>
                        </select>
                    </div>
                </div>

                <button onclick="app.runAudit()" id="audit-btn" disabled class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    LANCER L'ANALYSE & CRÉER PR <i data-lucide="zap" class="w-5 h-5"></i>
                </button>
            </div>
        </section>

        <!-- VIEW: VIBE -->
        <section id="view-vibe" class="view-transition hidden space-y-6">
            <button onclick="app.showView('home')" class="flex items-center gap-2 text-slate-500 hover:text-white text-sm transition-colors">
                <i data-lucide="chevron-left" class="w-4 h-4"></i> Retour à l'accueil
            </button>
            <div class="glass p-8 rounded-3xl space-y-8 border border-white/10">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <i data-lucide="wand-2" class="text-nexus-400"></i> Vibe Architect
                    </h2>
                    <span class="text-[10px] font-black bg-nexus-500 text-white px-2 py-1 rounded uppercase tracking-tighter">AUTO-PUSH GITHUB</span>
                </div>

                <div class="space-y-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Nom du Repository</label>
                    <input type="text" id="vibe-repo-name" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-white outline-none focus:ring-2 focus:ring-nexus-500" placeholder="ex: my-awesome-app">
                </div>

                <div class="space-y-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Votre Vision (Cahier des charges)</label>
                    <textarea id="vibe-prompt" rows="6" class="w-full bg-slate-900/50 border border-white/5 rounded-2xl p-6 outline-none focus:ring-2 focus:ring-nexus-500 text-lg placeholder-slate-700" placeholder="Décrivez votre app... ex: Un dashboard SaaS en Next.js avec authentification et un workflow de test automatique."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-slate-900/40 p-4 rounded-xl border border-white/5">
                        <label class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase mb-2">
                            <i data-lucide="package" class="w-3 h-3"></i> Stack
                        </label>
                        <select id="vibe-stack" class="w-full bg-transparent text-sm outline-none">
                            <option value="react">React + Vite</option>
                            <option value="nextjs">Next.js 14</option>
                            <option value="node">Node.js Express</option>
                            <option value="python">FastAPI Python</option>
                        </select>
                    </div>
                    <div class="bg-slate-900/40 p-4 rounded-xl border border-white/5">
                        <label class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase mb-2">
                            <i data-lucide="git-merge" class="w-3 h-3"></i> DevOps
                        </label>
                        <select id="vibe-devops" class="w-full bg-transparent text-sm outline-none">
                            <option value="gh-actions">GitHub Actions (Tests)</option>
                            <option value="full">CI/CD Complet</option>
                            <option value="none">Aucun</option>
                        </select>
                    </div>
                    <div class="bg-slate-900/40 p-4 rounded-xl border border-white/5">
                        <label class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase mb-2">
                            <i data-lucide="eye" class="w-3 h-3"></i> Style
                        </label>
                        <select id="vibe-style" class="w-full bg-transparent text-sm outline-none">
                            <option value="tailwind">Tailwind CSS</option>
                            <option value="shadcn">Shadcn UI</option>
                            <option value="mui">Material UI</option>
                        </select>
                    </div>
                </div>

                <button onclick="app.runGeneration()" class="w-full bg-nexus-600 hover:bg-nexus-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-nexus-500/20 transition-all uppercase tracking-widest italic">
                    Générer & Push sur GitHub
                </button>
            </div>
        </section>

        <!-- VIEW: PROJECTS -->
        <section id="view-projects" class="view-transition hidden space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-black text-white">Mes Projets</h1>
                <button onclick="app.showView('home')" class="text-sm text-slate-500 hover:text-white">Retour</button>
            </div>
            <div id="projects-list" class="space-y-4"></div>
        </section>

        <!-- VIEW: LOGS -->
        <section id="view-logs" class="view-transition hidden space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-black text-white">Logs Système</h1>
                <div class="flex gap-2">
                    <button onclick="app.sendFeedback()" class="text-sm bg-nexus-600 px-4 py-2 rounded-lg hover:bg-nexus-500 flex items-center gap-2">
                        <i data-lucide="mail" class="w-4 h-4"></i> Envoyer Feedback
                    </button>
                    <button onclick="app.exportLogs()" class="text-sm bg-slate-800 px-4 py-2 rounded-lg hover:bg-slate-700">
                        <i data-lucide="download" class="w-4 h-4 inline"></i> Exporter
                    </button>
                    <button onclick="app.clearLogs()" class="text-sm bg-red-600 px-4 py-2 rounded-lg hover:bg-red-500">
                        <i data-lucide="trash-2" class="w-4 h-4 inline"></i> Effacer
                    </button>
                </div>
            </div>
            
            <div class="glass p-6 rounded-3xl">
                <div class="flex gap-2 mb-4">
                    <button onclick="app.filterLogs('all')" class="filter-btn px-4 py-2 rounded-lg bg-nexus-500 text-white text-sm">Tous</button>
                    <button onclick="app.filterLogs('success')" class="filter-btn px-4 py-2 rounded-lg bg-slate-800 text-white text-sm">Succès</button>
                    <button onclick="app.filterLogs('error')" class="filter-btn px-4 py-2 rounded-lg bg-slate-800 text-white text-sm">Erreurs</button>
                    <button onclick="app.filterLogs('warning')" class="filter-btn px-4 py-2 rounded-lg bg-slate-800 text-white text-sm">Warnings</button>
                </div>
                <div id="logs-list" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
            </div>
        </section>

        <!-- VIEW: RESULTS -->
        <section id="view-results" class="view-transition hidden space-y-6">
            <div class="flex items-center justify-between">
                <h2 id="results-title" class="text-2xl font-black text-white uppercase italic">Analyse en cours...</h2>
                <button onclick="app.showView('home')" class="text-xs text-slate-500 hover:text-white uppercase font-bold">Fermer</button>
            </div>

            <div id="results-loader" class="glass p-20 rounded-3xl flex flex-col items-center justify-center space-y-6">
                <div class="loader w-12 h-12 border-4"></div>
                <div class="text-center">
                    <p class="text-white font-bold text-xl animate-pulse" id="loader-status">Consultation de l'IA...</p>
                    <p class="text-slate-500 text-sm mt-2" id="loader-subtext">Préparation du contexte</p>
                </div>
            </div>

            <div id="results-content" class="hidden space-y-6">
                <div class="glass p-8 rounded-3xl prose prose-invert max-w-none prose-pre:bg-slate-900/50" id="results-markdown"></div>
                <div id="results-actions" class="glass p-6 rounded-3xl space-y-4"></div>
            </div>
        </section>

        <!-- VIEW: CONFIG -->
        <section id="view-config" class="view-transition hidden space-y-6">
            <button onclick="app.showView('home')" class="flex items-center gap-2 text-slate-500 hover:text-white text-sm transition-colors">
                <i data-lucide="chevron-left" class="w-4 h-4"></i> Retour
            </button>
            
            <div class="glass p-8 rounded-3xl space-y-6 border border-white/10">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="key" class="text-yellow-500"></i> Configuration GitHub
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">GitHub Token</label>
                        <input type="password" id="cfg-gh-token" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-white outline-none focus:ring-1 focus:ring-nexus-500" placeholder="ghp_...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Username GitHub</label>
                        <input type="text" id="cfg-gh-username" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-white outline-none focus:ring-1 focus:ring-nexus-500" placeholder="votre-username">
                    </div>
                    <button onclick="app.testGitHub()" class="px-6 py-2 bg-slate-800 rounded-xl font-bold text-sm hover:bg-slate-700">Tester la connexion</button>
                </div>
            </div>

            <div class="glass p-8 rounded-3xl space-y-6 border border-white/10">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="brain" class="text-nexus-500"></i> Providers IA
                    </h2>
                    <button onclick="app.addProviderKey()" class="text-xs bg-nexus-600 px-3 py-1 rounded-lg font-bold hover:bg-nexus-500">+ Ajouter</button>
                </div>
                <div id="providers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <button onclick="app.saveConfig()" class="w-full bg-nexus-600 hover:bg-nexus-500 text-white font-bold py-4 rounded-xl">Sauvegarder la Configuration</button>
        </section>

    </main>

    <footer class="p-6 border-t border-white/5 text-center">
        <p class="text-[10px] text-slate-600 uppercase font-black tracking-[0.2em]">Nexus Guardian V4.2 — CSOP Protocol + Full Logs</p>
    </footer>

    <!-- Provider Modal -->
    <div id="provider-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass p-8 rounded-3xl max-w-2xl w-full mx-4 space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-white" id="modal-provider-name"></h3>
                <button onclick="app.closeProviderModal()" class="text-slate-500 hover:text-white">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Clé API</label>
                    <input type="password" id="modal-api-key" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-white outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Rôle</label>
                    <select id="modal-role" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-white outline-none">
                        <option value="">Désactivé</option>
                        <option value="lead">Lead (Chef d'orchestre)</option>
                        <option value="worker">Worker (Exécutant)</option>
                    </select>
                </div>
                <button onclick="app.fetchModels()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl">Charger les Modèles</button>
                <div id="modal-models" class="hidden space-y-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Modèles Disponibles</label>
                    <select id="modal-model-select" class="w-full bg-slate-900 border border-white/5 rounded-xl px-4 py-3 text-white outline-none"></select>
                </div>
            </div>
            <button onclick="app.saveProvider()" class="w-full bg-nexus-600 hover:bg-nexus-500 text-white font-bold py-4 rounded-xl">Sauvegarder</button>
        </div>
    </div>

    <script type="module">
        import { CSOP } from 'https://cdn.jsdelivr.net/gh/Nexus-Studio-CEO/CSOP@v0.1.0/src/csop.js';

        // Initialize CSOP
        let csop;
        (async () => {
            csop = new CSOP();
            await csop.init();
            console.log('CSOP initialized');
        })();

        // ========== PROVIDERS & PERSONAS ==========
        const PROVIDERS = {
            anthropic: { name: 'Anthropic Claude', endpoint: 'https://api.anthropic.com/v1/messages', type: 'paid', modelsEndpoint: null, defaultModels: ['claude-sonnet-4-20250514', 'claude-opus-4-20250514'] },
            groq: { name: 'Groq', endpoint: 'https://api.groq.com/openai/v1/chat/completions', type: 'free', modelsEndpoint: 'https://api.groq.com/openai/v1/models' },
            openrouter: { name: 'OpenRouter', endpoint: 'https://openrouter.ai/api/v1/chat/completions', type: 'paid', modelsEndpoint: 'https://openrouter.ai/api/v1/models' },
            huggingface: { name: 'Hugging Face', endpoint: 'https://api-inference.huggingface.co/models/', type: 'free', defaultModels: ['meta-llama/Llama-3.3-70B-Instruct', 'mistralai/Mixtral-8x7B-Instruct-v0.1'] },
            openai: { name: 'OpenAI', endpoint: 'https://api.openai.com/v1/chat/completions', type: 'paid', modelsEndpoint: 'https://api.openai.com/v1/models' },
            gemini: { name: 'Google Gemini', endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/', type: 'free', modelsEndpoint: 'https://generativelanguage.googleapis.com/v1beta/models' }
        };

        const PERSONAS = {
            architect: {
                name: 'Lead Architecte',
                prompt: 'Tu es un architecte logiciel senior. Analyse ce code avec une vision holistique : architecture globale, patterns de design, scalabilité, maintenabilité. Propose des refactorings structurels.'
            },
            security: {
                name: 'Expert Sécurité',
                prompt: 'Tu es un expert en cybersécurité paranoïaque. Cherche toutes les vulnérabilités potentielles : injections SQL, XSS, CSRF, fuites de données, mauvaises pratiques crypto. Sois ultra-strict.'
            },
            mentor: {
                name: 'Mentor Dev',
                prompt: 'Tu es un mentor pédagogique bienveillant. Explique chaque problème trouvé de manière claire et éducative, avec des exemples de bonnes pratiques. Guide le développeur vers l\'amélioration.'
            }
        };

        // ========== APPLICATION CORE ==========
        window.app = {
            state: {
                currentView: 'home',
                auditDepth: 'full',
                currentProvider: null,
                selectedRepo: null,
                userRepos: [],
                logFilter: 'all'
            },

            async init() {
                try {
                    lucide.createIcons();
                    await app.loadConfig();
                    await app.renderProviders();
                    await app.renderProjects();
                    await app.updateStats();
                    await app.renderLogs();
                } catch (e) {
                    console.error('Init error:', e);
                    app.log('error', 'Erreur d\'initialisation', { error: e.message });
                    app.toast('Erreur d\'initialisation', 'error');
                }
            },

            async log(type, message, data = {}) {
                const logEntry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type,
                    message,
                    data,
                    workflow: data.workflow || 'general'
                };
                
                if (csop) {
                    try {
                        const existingLogs = await csop.dispatch('storage.get', { key: 'nexus_logs' }).catch(() => ({ data: [] }));
                        const logs = existingLogs.data || [];
                        logs.unshift(logEntry);
                        
                        if (logs.length > 1000) logs.splice(1000);
                        
                        await csop.dispatch('storage.save', { key: 'nexus_logs', data: logs });
                    } catch (e) {
                        console.error('Log save error:', e);
                    }
                }
                
                console.log(`[${type.toUpperCase()}]`, message, data);
            },

            showView(view) {
                document.querySelectorAll('.view-transition').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                app.state.currentView = view;
                lucide.createIcons();
                window.scrollTo(0, 0);
                
                if (view === 'projects') app.renderProjects();
                if (view === 'logs') app.renderLogs();
            },

            setAuditDepth(depth) {
                app.state.auditDepth = depth;
                document.querySelectorAll('.depth-btn').forEach(btn => {
                    btn.classList.remove('border-nexus-500', 'bg-nexus-500/10');
                    btn.classList.add('border-white/10');
                });
                const btn = document.getElementById(`depth-${depth}`);
                btn.classList.add('border-nexus-500', 'bg-nexus-500/10');
                btn.classList.remove('border-white/10');
            },

            toast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
                toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg font-bold text-sm toast-enter`;
                toast.textContent = msg;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('toast-enter');
                    toast.classList.add('toast-exit');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            async loadConfig() {
                if (!csop) {
                    // Fallback localStorage si CSOP pas encore prêt
                    const stored = localStorage.getItem('nexus_config_backup');
                    if (stored) {
                        const config = JSON.parse(stored);
                        if (config?.github?.token) {
                            document.getElementById('cfg-gh-token').value = config.github.token;
                        }
                        if (config?.github?.username) {
                            document.getElementById('cfg-gh-username').value = config.github.username;
                        }
                    }
                    return;
                }
                
                try {
                    const config = await csop.dispatch('storage.get', { key: 'nexus_config' });
                    if (config?.data?.github?.token) {
                        document.getElementById('cfg-gh-token').value = config.data.github.token;
                    }
                    if (config?.data?.github?.username) {
                        document.getElementById('cfg-gh-username').value = config.data.github.username;
                    }
                } catch (e) {
                    console.log('No config found in CSOP, checking localStorage');
                    // Essayer localStorage en fallback
                    const stored = localStorage.getItem('nexus_config_backup');
                    if (stored) {
                        const config = JSON.parse(stored);
                        if (config?.github?.token) {
                            document.getElementById('cfg-gh-token').value = config.github.token;
                        }
                        if (config?.github?.username) {
                            document.getElementById('cfg-gh-username').value = config.github.username;
                        }
                        // Migrer vers CSOP
                        if (csop) {
                            await csop.dispatch('storage.save', {
                                key: 'nexus_config',
                                data: config
                            });
                        }
                    }
                }
            },

            async saveConfig() {
                const configData = {
                    github: {
                        token: document.getElementById('cfg-gh-token').value,
                        username: document.getElementById('cfg-gh-username').value
                    },
                    updatedAt: Date.now()
                };
                
                // Toujours sauver dans localStorage comme backup
                localStorage.setItem('nexus_config_backup', JSON.stringify(configData));
                
                if (!csop) {
                    app.toast('Configuration sauvegardée (localStorage)', 'warning');
                    return;
                }
                
                try {
                    await csop.dispatch('storage.save', {
                        key: 'nexus_config',
                        data: configData
                    });
                    
                    await app.log('success', 'Configuration sauvegardée', { workflow: 'config' });
                    app.toast('Configuration sauvegardée');
                } catch (e) {
                    await app.log('error', 'Erreur sauvegarde config', { workflow: 'config', error: e.message });
                    app.toast('Sauvegardé en localStorage uniquement', 'warning');
                }
            },

            async testGitHub() {
                const token = document.getElementById('cfg-gh-token').value;
                if (!token) return app.toast('Veuillez entrer un token', 'error');
                
                await app.log('info', 'Test connexion GitHub', { workflow: 'github_auth' });
                
                try {
                    const res = await fetch('https://api.github.com/user', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        await app.log('success', `Connecté à GitHub: ${data.login}`, { workflow: 'github_auth', username: data.login });
                        app.toast(`✓ Connecté: ${data.login}`);
                    } else {
                        await app.log('error', 'Token GitHub invalide', { workflow: 'github_auth', status: res.status });
                        app.toast('Token invalide', 'error');
                    }
                } catch (e) {
                    await app.log('error', 'Erreur connexion GitHub', { workflow: 'github_auth', error: e.message });
                    app.toast('Erreur de connexion', 'error');
                }
            },

            async fetchUserRepos() {
                let token, username;
                
                // Essayer de récupérer depuis les inputs d'abord
                token = document.getElementById('cfg-gh-token').value;
                username = document.getElementById('cfg-gh-username').value;
                
                // Si vides, essayer CSOP
                if (!token || !username) {
                    if (csop) {
                        try {
                            const config = await csop.dispatch('storage.get', { key: 'nexus_config' });
                            token = config?.data?.github?.token;
                            username = config?.data?.github?.username;
                        } catch (e) {
                            // Essayer localStorage
                            const stored = localStorage.getItem('nexus_config_backup');
                            if (stored) {
                                const config = JSON.parse(stored);
                                token = config?.github?.token;
                                username = config?.github?.username;
                            }
                        }
                    } else {
                        // Fallback localStorage
                        const stored = localStorage.getItem('nexus_config_backup');
                        if (stored) {
                            const config = JSON.parse(stored);
                            token = config?.github?.token;
                            username = config?.github?.username;
                        }
                    }
                }
                
                if (!token || !username) {
                    app.toast('Configurez GitHub Token + Username dans Config', 'error');
                    app.showView('config');
                    return;
                }

                await app.log('info', 'Chargement repositories utilisateur', { workflow: 'github_repos', username });
                app.toast('Chargement des repos...', 'warning');
                
                try {
                    const res = await fetch(`https://api.github.com/users/${username}/repos?per_page=100&sort=updated`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!res.ok) throw new Error('Erreur récupération repos');
                    
                    const repos = await res.json();
                    app.state.userRepos = repos;
                    
                    await app.log('success', `${repos.length} repositories chargés`, { workflow: 'github_repos', count: repos.length });
                    
                    const list = document.getElementById('repos-list');
                    list.innerHTML = repos.map(repo => `
                        <div class="repo-card glass p-4 rounded-xl cursor-pointer hover:border-nexus-500 border border-white/5 transition-all" onclick="app.selectRepo('${repo.owner.login}', '${repo.name}', '${repo.default_branch}')">
                            <div class="flex justify-between items-start">
                                <div class="flex-grow">
                                    <h3 class="font-bold text-white">${repo.name}</h3>
                                    <p class="text-xs text-slate-500 mt-1">${repo.description || 'Pas de description'}</p>
                                    <div class="flex gap-3 mt-2 text-xs text-slate-400">
                                        <span><i data-lucide="star" class="w-3 h-3 inline"></i> ${repo.stargazers_count}</span>
                                        <span><i data-lucide="git-branch" class="w-3 h-3 inline"></i> ${repo.default_branch}</span>
                                        ${repo.language ? `<span><i data-lucide="code" class="w-3 h-3 inline"></i> ${repo.language}</span>` : ''}
                                    </div>
                                </div>
                                <span class="text-xs ${repo.private ? 'text-yellow-500' : 'text-green-500'}">${repo.private ? 'Privé' : 'Public'}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    lucide.createIcons();
                    app.toast(`${repos.length} repos chargés`);
                } catch (e) {
                    await app.log('error', 'Erreur chargement repos', { workflow: 'github_repos', error: e.message });
                    app.toast('Erreur: ' + e.message, 'error');
                }
            },

            selectRepo(owner, repo, branch) {
                app.state.selectedRepo = { owner, repo, branch };
                
                document.querySelectorAll('.repo-card').forEach(card => {
                    card.classList.remove('border-nexus-500', 'bg-nexus-500/5');
                    card.classList.add('border-white/5');
                });
                
                event.currentTarget.classList.remove('border-white/5');
                event.currentTarget.classList.add('border-nexus-500', 'bg-nexus-500/5');
                
                document.getElementById('audit-btn').disabled = false;
                
                app.log('info', `Repository sélectionné: ${owner}/${repo}`, { workflow: 'audit_prep' });
                app.toast(`✓ ${repo} sélectionné`);
            },

            async runAudit() {
                if (!app.state.selectedRepo) {
                    app.toast('Sélectionnez un repository', 'error');
                    return;
                }

                const { owner, repo, branch } = app.state.selectedRepo;
                const persona = document.getElementById('audit-persona').value;
                const depth = app.state.auditDepth;
                
                await app.log('info', `Début audit: ${owner}/${repo}`, { 
                    workflow: 'audit_run',
                    repo: `${owner}/${repo}`,
                    branch,
                    persona,
                    depth
                });

                let leadProvider, providerConfig, token;

                try {
                    // Récupérer provider Lead
                    if (csop) {
                        try {
                            const leadCfg = await csop.dispatch('storage.get', { key: 'nexus_lead_provider' });
                            if (!leadCfg?.data) throw new Error('Provider Lead non configuré');
                            leadProvider = leadCfg.data;
                            
                            const provCfg = await csop.dispatch('storage.get', { key: `nexus_provider_${leadProvider}` });
                            if (!provCfg?.data?.apiKey || !provCfg?.data?.selectedModel) {
                                throw new Error('Configuration Lead incomplète');
                            }
                            providerConfig = provCfg.data;
                        } catch (e) {
                            throw new Error('Configurez un Provider Lead dans Config');
                        }
                    } else {
                        throw new Error('CSOP non initialisé');
                    }

                    // Récupérer token GitHub - multiples sources
                    token = document.getElementById('cfg-gh-token').value;
                    
                    if (!token && csop) {
                        try {
                            const config = await csop.dispatch('storage.get', { key: 'nexus_config' });
                            token = config?.data?.github?.token;
                        } catch (e) {}
                    }
                    
                    if (!token) {
                        const stored = localStorage.getItem('nexus_config_backup');
                        if (stored) {
                            const config = JSON.parse(stored);
                            token = config?.github?.token;
                        }
                    }
                    
                    if (!token) {
                        throw new Error('Token GitHub manquant - Configurez-le dans Config');
                    }
                    
                    await app.log('info', 'Configuration chargée avec succès', { workflow: 'audit_run', provider: leadProvider });
                    
                } catch (e) {
                    await app.log('error', 'Erreur configuration', { workflow: 'audit_run', error: e.message });
                    app.toast(e.message, 'error');
                    return;
                }
                
                app.showView('results');
                document.getElementById('results-title').textContent = `Audit: ${owner}/${repo}`;
                document.getElementById('results-loader').classList.remove('hidden');
                document.getElementById('results-content').classList.add('hidden');
                
                const status = document.getElementById('loader-status');
                const sub = document.getElementById('loader-subtext');
                
                try {
                    status.textContent = 'Récupération du repository...';
                    sub.textContent = 'Connexion à GitHub API';
                    await app.log('info', 'Fetch arbre fichiers', { workflow: 'audit_run' });
                    await new Promise(r => setTimeout(r, 800));
                    
                    const treeRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!treeRes.ok) {
                        const errorText = await treeRes.text();
                        throw new Error(`GitHub API Error ${treeRes.status}: ${errorText}`);
                    }
                    
                    const treeData = await treeRes.json();
                    const files = treeData.tree.filter(f => f.type === 'blob');
                    
                    await app.log('success', `${files.length} fichiers détectés`, { workflow: 'audit_run', filesCount: files.length });
                    
                    status.textContent = `Analyse ${depth === 'skeleton' ? 'squelette' : 'intégrale'}...`;
                    sub.textContent = `${files.length} fichiers détectés`;
                    await new Promise(r => setTimeout(r, 1000));
                    
                    status.textContent = `Consultation ${PERSONAS[persona].name}...`;
                    sub.textContent = 'L\'IA compile les recommandations';
                    
                    const fileList = files.slice(0, depth === 'skeleton' ? 20 : 50).map(f => f.path).join('\n');
                    
                    const prompt = `${PERSONAS[persona].prompt}

Repository: ${owner}/${repo}
Branche: ${branch}
Profondeur: ${depth === 'skeleton' ? 'Architecture uniquement' : 'Analyse complète'}
Fichiers (${files.length} total):
${fileList}

Fournis un rapport d'audit complet au format Markdown avec:
1. Résumé de santé (complexité, sécurité, dette technique)
2. Problèmes critiques identifiés avec fichiers et lignes
3. Recommandations d'amélioration concrètes
4. Plan d'action avec code de correction si nécessaire`;
                    
                    await app.log('info', 'Appel IA pour analyse', { workflow: 'audit_run', provider: leadProvider });
                    
                    const aiResponse = await app.callAI(leadProvider, providerConfig, prompt);
                    
                    await app.log('success', 'Analyse IA terminée', { workflow: 'audit_run', responseLength: aiResponse.length });
                    
                    status.textContent = 'Création de la Pull Request...';
                    sub.textContent = 'Push des corrections sur GitHub';
                    await new Promise(r => setTimeout(r, 800));
                    
                    const prUrl = await app.createPR(owner, repo, branch, aiResponse, token);
                    
                    if (prUrl) {
                        await app.log('success', 'PR créée avec succès', { workflow: 'audit_run', prUrl });
                    }
                    
                    if (csop) {
                        await csop.dispatch('storage.save', {
                            key: `nexus_project_${owner}_${repo}`,
                            data: {
                                id: `${owner}/${repo}`,
                                owner,
                                repo,
                                branch,
                                type: 'audited',
                                addedAt: Date.now(),
                                lastAccessedAt: Date.now(),
                                githubUrl: `https://github.com/${owner}/${repo}`,
                                lastAudit: {
                                    timestamp: Date.now(),
                                    persona,
                                    depth,
                                    provider: leadProvider,
                                    model: providerConfig.selectedModel,
                                    prUrl
                                }
                            }
                        });
                    }
                    
                    await app.updateStats();
                    app.displayResults(aiResponse, { type: 'audit', prUrl, repoUrl: `https://github.com/${owner}/${repo}` });
                    
                } catch (e) {
                    console.error('Audit error:', e);
                    await app.log('error', 'Erreur audit', { workflow: 'audit_run', error: e.message, stack: e.stack });
                    app.toast('Erreur: ' + e.message, 'error');
                    app.showView('audit');
                }
            },

            async runGeneration() {
                const repoName = document.getElementById('vibe-repo-name').value.trim();
                const prompt = document.getElementById('vibe-prompt').value.trim();
                const stack = document.getElementById('vibe-stack').value;
                const devops = document.getElementById('vibe-devops').value;
                const style = document.getElementById('vibe-style').value;
                
                if (!repoName) return app.toast('Entrez un nom de repo', 'error');
                if (!prompt) return app.toast('Décrivez votre projet', 'error');
                
                await app.log('info', `Début génération: ${repoName}`, {
                    workflow: 'vibe_generation',
                    repoName,
                    stack,
                    devops,
                    style
                });

                if (!csop) return app.toast('CSOP non initialisé', 'error');

                let leadProvider, providerConfig, token, username;

                try {
                    const leadCfg = await csop.dispatch('storage.get', { key: 'nexus_lead_provider' });
                    if (!leadCfg?.data) throw new Error('Provider Lead non configuré');
                    leadProvider = leadCfg.data;
                    
                    const provCfg = await csop.dispatch('storage.get', { key: `nexus_provider_${leadProvider}` });
                    if (!provCfg?.data?.apiKey || !provCfg?.data?.selectedModel) {
                        throw new Error('Configuration Lead incomplète');
                    }
                    providerConfig = provCfg.data;

                    const config = await csop.dispatch('storage.get', { key: 'nexus_config' });
                    token = config?.data?.github?.token;
                    username = config?.data?.github?.username;
                    
                    if (!token || !username) throw new Error('Configurez GitHub Token + Username');
                } catch (e) {
                    await app.log('error', 'Erreur configuration', { workflow: 'vibe_generation', error: e.message });
                    app.toast(e.message, 'error');
                    return;
                }
                
                app.showView('results');
                document.getElementById('results-title').textContent = 'Génération Vibe';
                document.getElementById('results-loader').classList.remove('hidden');
                document.getElementById('results-content').classList.add('hidden');
                
                const status = document.getElementById('loader-status');
                const sub = document.getElementById('loader-subtext');
                
                try {
                    status.textContent = 'Structuration de l\'architecture...';
                    sub.textContent = 'Conception de l\'arborescence';
                    await app.log('info', 'Génération architecture', { workflow: 'vibe_generation' });
                    await new Promise(r => setTimeout(r, 1200));
                    
                    status.textContent = 'Génération du code source...';
                    sub.textContent = 'Écriture des composants';
                    await new Promise(r => setTimeout(r, 1500));
                    
                    status.textContent = 'Auto-DevOps Engineering...';
                    sub.textContent = 'Configuration CI/CD';
                    
                    const genPrompt = `Tu es un architecte génératif expert. Génère un projet complet basé sur:

Vision: ${prompt}
Stack: ${stack}
DevOps: ${devops}
Style: ${style}

Fournis au format Markdown avec CETTE STRUCTURE EXACTE:

# Projet: [nom]

## Arborescence
\`\`\`
[arborescence complète]
\`\`\`

## Fichiers

### package.json
\`\`\`json
[contenu]
\`\`\`

### README.md
\`\`\`markdown
[contenu]
\`\`\`

${devops !== 'none' ? '### .github/workflows/ci.yml\n```yaml\n[workflow GitHub Actions complet]\n```' : ''}

### src/index.js (ou main file)
\`\`\`javascript
[contenu]
\`\`\`

[autres fichiers clés avec leur contenu complet]

## Instructions
[setup et déploiement]

Sois exhaustif, professionnel et prêt pour production.`;
                    
                    await app.log('info', 'Appel IA pour génération', { workflow: 'vibe_generation', provider: leadProvider });
                    const aiResponse = await app.callAI(leadProvider, providerConfig, genPrompt);
                    
                    await app.log('success', 'Génération IA terminée', { workflow: 'vibe_generation', responseLength: aiResponse.length });
                    
                    status.textContent = 'Création du repository GitHub...';
                    sub.textContent = 'Initialisation';
                    await new Promise(r => setTimeout(r, 800));
                    
                    const repoUrl = await app.createRepoAndPush(repoName, aiResponse, username, token);
                    
                    if (repoUrl) {
                        await app.log('success', 'Repository créé avec succès', { workflow: 'vibe_generation', repoUrl });
                    }
                    
                    await csop.dispatch('storage.save', {
                        key: `nexus_project_${repoName}`,
                        data: {
                            id: repoName,
                            name: repoName,
                            type: 'generated',
                            addedAt: Date.now(),
                            stack,
                            devops,
                            style,
                            githubUrl: repoUrl
                        }
                    });
                    
                    await app.updateStats();
                    app.displayResults(aiResponse, { type: 'generation', repoUrl });
                    
                } catch (e) {
                    console.error('Generation error:', e);
                    await app.log('error', 'Erreur génération', { workflow: 'vibe_generation', error: e.message, stack: e.stack });
                    app.toast('Erreur: ' + e.message, 'error');
                    app.showView('vibe');
                }
            },

            async createPR(owner, repo, branch, auditReport, token) {
                try {
                    const newBranch = `nexus-fixes-${Date.now()}`;
                    
                    await app.log('info', 'Création branche PR', { workflow: 'github_pr', branch: newBranch });
                    
                    const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${branch}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const refData = await refRes.json();
                    const sha = refData.object.sha;
                    
                    await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ref: `refs/heads/${newBranch}`,
                            sha: sha
                        })
                    });
                    
                    await app.log('info', 'Création Pull Request', { workflow: 'github_pr' });
                    
                    const prRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/pulls`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: '🔧 NEXUS Guardian - Corrections Automatiques',
                            body: `## Rapport d'Audit NEXUS Guardian\n\n${auditReport}\n\n---\n*Généré automatiquement par NEXUS Guardian*`,
                            head: newBranch,
                            base: branch
                        })
                    });
                    
                    const prData = await prRes.json();
                    return prData.html_url;
                } catch (e) {
                    await app.log('error', 'Erreur création PR', { workflow: 'github_pr', error: e.message });
                    console.error('PR creation error:', e);
                    return null;
                }
            },

            async createRepoAndPush(repoName, generatedContent, username, token) {
                try {
                    await app.log('info', 'Création repository', { workflow: 'github_create_repo', repoName });
                    
                    const createRes = await fetch('https://api.github.com/user/repos', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: repoName,
                            description: 'Generated by NEXUS Guardian Vibe Coding',
                            private: false,
                            auto_init: true
                        })
                    });
                    
                    if (!createRes.ok) {
                        const error = await createRes.text();
                        throw new Error(`Échec création repo: ${error}`);
                    }
                    
                    const repoData = await createRes.json();
                    const repoUrl = repoData.html_url;
                    
                    await app.log('success', 'Repository créé', { workflow: 'github_create_repo', repoUrl });
                    await new Promise(r => setTimeout(r, 2000)); // Wait for repo init
                    
                    const files = app.parseGeneratedFiles(generatedContent);
                    
                    await app.log('info', `Push de ${files.length} fichiers`, { workflow: 'github_push', filesCount: files.length });
                    
                    for (const file of files) {
                        await fetch(`https://api.github.com/repos/${username}/${repoName}/contents/${file.path}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Add ${file.path}`,
                                content: btoa(unescape(encodeURIComponent(file.content)))
                            })
                        });
                    }
                    
                    await app.log('success', 'Tous les fichiers pushés', { workflow: 'github_push' });
                    
                    return repoUrl;
                } catch (e) {
                    await app.log('error', 'Erreur création/push repo', { workflow: 'github_create_repo', error: e.message });
                    console.error('Repo creation error:', e);
                    throw e;
                }
            },

            parseGeneratedFiles(markdown) {
                const files = [];
                const codeBlockRegex = /###\s+(.+?)\n```(?:\w+)?\n([\s\S]+?)\n```/g;
                let match;
                
                while ((match = codeBlockRegex.exec(markdown)) !== null) {
                    const path = match[1].trim();
                    const content = match[2].trim();
                    files.push({ path, content });
                }
                
                if (files.length === 0) {
                    files.push({
                        path: 'README.md',
                        content: markdown
                    });
                }
                
                return files;
            },

            async callAI(providerKey, config, prompt) {
                const p = PROVIDERS[providerKey];
                const { apiKey, selectedModel } = config;
                
                let url = p.endpoint;
                let headers = { 'Content-Type': 'application/json' };
                let body = {};
                
                if (providerKey === 'anthropic') {
                    headers['x-api-key'] = apiKey;
                    headers['anthropic-version'] = '2023-06-01';
                    body = {
                        model: selectedModel,
                        max_tokens: 4096,
                        messages: [{ role: 'user', content: prompt }]
                    };
                } else if (providerKey === 'groq' || providerKey === 'openai' || providerKey === 'openrouter') {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    if (providerKey === 'openrouter') {
                        headers['HTTP-Referer'] = window.location.href;
                        headers['X-Title'] = 'NEXUS Guardian';
                    }
                    body = {
                        model: selectedModel,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 4096
                    };
                } else if (providerKey === 'huggingface') {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    url = p.endpoint + selectedModel;
                    body = {
                        inputs: prompt,
                        parameters: { max_new_tokens: 2000 }
                    };
                } else if (providerKey === 'gemini') {
                    url = `${p.endpoint}${selectedModel}:generateContent?key=${apiKey}`;
                    body = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                }
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`API Error ${res.status}: ${errorText}`);
                }
                
                const data = await res.json();
                
                if (providerKey === 'anthropic') {
                    return data.content[0].text;
                } else if (providerKey === 'groq' || providerKey === 'openai' || providerKey === 'openrouter') {
                    return data.choices[0].message.content;
                } else if (providerKey === 'huggingface') {
                    return data[0]?.generated_text || data.generated_text;
                } else if (providerKey === 'gemini') {
                    return data.candidates[0].content.parts[0].text;
                }
                
                return '';
            },

            displayResults(markdown, meta = {}) {
                document.getElementById('results-loader').classList.add('hidden');
                const content = document.getElementById('results-content');
                const markdownDiv = document.getElementById('results-markdown');
                const actionsDiv = document.getElementById('results-actions');
                
                content.classList.remove('hidden');
                markdownDiv.innerHTML = marked.parse(markdown);
                
                let actionsHtml = '';
                
                if (meta.type === 'audit' && meta.prUrl) {
                    actionsHtml = `
                        <h3 class="font-bold text-white text-lg mb-4">✅ Analyse Terminée</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <a href="${meta.prUrl}" target="_blank" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl text-center">
                                <i data-lucide="git-pull-request" class="w-4 h-4 inline mr-2"></i>
                                Voir la Pull Request
                            </a>
                            <a href="${meta.repoUrl}" target="_blank" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-xl text-center">
                                <i data-lucide="github" class="w-4 h-4 inline mr-2"></i>
                                Voir le Repository
                            </a>
                        </div>
                    `;
                } else if (meta.type === 'generation' && meta.repoUrl) {
                    actionsHtml = `
                        <h3 class="font-bold text-white text-lg mb-4">🚀 Projet Créé avec Succès</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <a href="${meta.repoUrl}" target="_blank" class="bg-nexus-600 hover:bg-nexus-500 text-white font-bold py-3 px-6 rounded-xl text-center">
                                <i data-lucide="github" class="w-4 h-4 inline mr-2"></i>
                                Voir sur GitHub
                            </a>
                            <button onclick="app.toast('Lien copié!', 'success'); navigator.clipboard.writeText('${meta.repoUrl}')" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-xl">
                                <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>
                                Copier le Lien
                            </button>
                        </div>
                    `;
                }
                
                actionsDiv.innerHTML = actionsHtml;
                lucide.createIcons();
            },

            async renderProjects() {
                if (!csop) return;
                
                try {
                    const allKeys = await csop.dispatch('storage.list', { prefix: 'nexus_project_' });
                    const projects = [];
                    
                    for (const key of allKeys.data || []) {
                        try {
                            const proj = await csop.dispatch('storage.get', { key });
                            if (proj?.data) projects.push(proj.data);
                        } catch (e) {
                            console.error('Error loading project:', e);
                        }
                    }
                    
                    const list = document.getElementById('projects-list');
                    
                    if (projects.length === 0) {
                        list.innerHTML = `
                            <div class="glass p-8 rounded-2xl text-center text-slate-500">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 opacity-30"></i>
                                <p>Aucun projet pour le moment</p>
                            </div>
                        `;
                    } else {
                        list.innerHTML = projects.map(proj => {
                            return `
                                <div class="glass p-6 rounded-xl">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-grow">
                                            <div class="flex items-center gap-2">
                                                <h3 class="font-bold text-white text-lg">${proj.id}</h3>
                                                ${proj.type === 'generated' ? '<span class="text-xs bg-nexus-500 px-2 py-1 rounded">Généré</span>' : '<span class="text-xs bg-blue-500 px-2 py-1 rounded">Audité</span>'}
                                            </div>
                                            <p class="text-xs text-slate-500 mt-1">Ajouté le ${new Date(proj.addedAt).toLocaleDateString()}</p>
                                            ${proj.githubUrl ? `<a href="${proj.githubUrl}" target="_blank" class="text-xs text-nexus-400 hover:text-nexus-300 mt-2 inline-flex items-center gap-1">
                                                <i data-lucide="external-link" class="w-3 h-3"></i>
                                                Voir sur GitHub
                                            </a>` : ''}
                                        </div>
                                        <button onclick="app.deleteProject('${proj.id}')" class="text-red-500 hover:text-red-400">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    lucide.createIcons();
                } catch (e) {
                    console.error('Error rendering projects:', e);
                }
            },

            async renderLogs() {
                if (!csop) return;
                
                try {
                    const logsData = await csop.dispatch('storage.get', { key: 'nexus_logs' });
                    let logs = logsData?.data || [];
                    
                    if (app.state.logFilter !== 'all') {
                        logs = logs.filter(log => log.type === app.state.logFilter);
                    }
                    
                    const list = document.getElementById('logs-list');
                    
                    if (logs.length === 0) {
                        list.innerHTML = `
                            <div class="text-center text-slate-500 py-8">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 opacity-30"></i>
                                <p>Aucun log disponible</p>
                            </div>
                        `;
                    } else {
                        list.innerHTML = logs.map(log => {
                            const icon = {
                                success: 'check-circle',
                                error: 'x-circle',
                                warning: 'alert-triangle',
                                info: 'info'
                            }[log.type] || 'info';
                            
                            return `
                                <div class="log-entry ${log.type} glass p-4 rounded-xl">
                                    <div class="flex items-start gap-3">
                                        <i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
                                        <div class="flex-grow">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <p class="font-bold text-white">${log.message}</p>
                                                    <p class="text-xs text-slate-500 mt-1">
                                                        ${new Date(log.timestamp).toLocaleString()} • 
                                                        <span class="text-nexus-400">${log.workflow}</span>
                                                    </p>
                                                </div>
                                            </div>
                                            ${Object.keys(log.data).length > 0 ? `
                                                <details class="mt-2">
                                                    <summary class="text-xs text-slate-400 cursor-pointer hover:text-white">Détails</summary>
                                                    <pre class="text-xs bg-slate-900 p-2 rounded mt-2 overflow-x-auto">${JSON.stringify(log.data, null, 2)}</pre>
                                                </details>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    lucide.createIcons();
                } catch (e) {
                    console.error('Error rendering logs:', e);
                }
            },

            filterLogs(filter) {
                app.state.logFilter = filter;
                
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-nexus-500');
                    btn.classList.add('bg-slate-800');
                });
                
                event.currentTarget.classList.remove('bg-slate-800');
                event.currentTarget.classList.add('bg-nexus-500');
                
                app.renderLogs();
            },

            async exportLogs() {
                if (!csop) return;
                
                try {
                    const logsData = await csop.dispatch('storage.get', { key: 'nexus_logs' });
                    const logs = logsData?.data || [];
                    
                    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nexus-logs-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    app.toast('Logs exportés');
                } catch (e) {
                    app.toast('Erreur export', 'error');
                }
            },

            async clearLogs() {
                if (!confirm('Effacer tous les logs ?')) return;
                
                if (!csop) return;
                
                try {
                    await csop.dispatch('storage.save', { key: 'nexus_logs', data: [] });
                    await app.renderLogs();
                    await app.updateStats();
                    app.toast('Logs effacés');
                } catch (e) {
                    app.toast('Erreur effacement', 'error');
                }
            },

            async sendFeedback() {
                const email = 'nexusstudio100@gmail.com';
                const subject = encodeURIComponent('Feedback NEXUS Guardian');
                
                let logsText = '';
                
                if (csop) {
                    try {
                        const logsData = await csop.dispatch('storage.get', { key: 'nexus_logs' });
                        const logs = logsData?.data || [];
                        logsText = logs.slice(0, 10).map(log => 
                            `[${log.type.toUpperCase()}] ${log.timestamp} - ${log.message}`
                        ).join('\n');
                    } catch (e) {
                        logsText = 'Erreur récupération logs';
                    }
                }
                
                const body = encodeURIComponent(`Bonjour,

Voici mon feedback sur NEXUS Guardian:

[Écrivez votre feedback ici]

---
Derniers logs système:
${logsText}

---
Envoyé depuis NEXUS Guardian V4.2`);
                
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                
                await app.log('info', 'Email feedback ouvert', { workflow: 'feedback' });
            },

            async deleteProject(id) {
                if (!confirm('Supprimer ce projet ?')) return;
                
                if (!csop) return;
                
                try {
                    await csop.dispatch('storage.delete', { key: `nexus_project_${id}` });
                    await app.renderProjects();
                    await app.updateStats();
                    await app.log('info', `Projet supprimé: ${id}`, { workflow: 'project_delete' });
                    app.toast('Projet supprimé');
                } catch (e) {
                    app.toast('Erreur suppression', 'error');
                }
            },

            async updateStats() {
                if (!csop) return;
                
                try {
                    const projectKeys = await csop.dispatch('storage.list', { prefix: 'nexus_project_' });
                    const projectsCount = projectKeys?.data?.length || 0;
                    
                    const logsData = await csop.dispatch('storage.get', { key: 'nexus_logs' });
                    const logsCount = logsData?.data?.length || 0;
                    
                    const providerKeys = await csop.dispatch('storage.list', { prefix: 'nexus_provider_' });
                    let enabledProviders = 0;
                    for (const key of providerKeys?.data || []) {
                        try {
                            const prov = await csop.dispatch('storage.get', { key });
                            if (prov?.data?.enabled) enabledProviders++;
                        } catch (e) {}
                    }
                    
                    const analysesCount = projectsCount;
                    
                    document.getElementById('stat-projects').textContent = projectsCount;
                    document.getElementById('stat-analyses').textContent = analysesCount;
                    document.getElementById('stat-providers').textContent = enabledProviders;
                    document.getElementById('stat-logs').textContent = logsCount;
                } catch (e) {
                    console.error('Error updating stats:', e);
                }
            },

            async renderProviders() {
                if (!csop) return;
                
                const grid = document.getElementById('providers-grid');
                const providersHtml = [];
                
                for (const key of Object.keys(PROVIDERS)) {
                    const p = PROVIDERS[key];
                    let cfg = {};
                    
                    try {
                        const provData = await csop.dispatch('storage.get', { key: `nexus_provider_${key}` });
                        cfg = provData?.data || {};
                    } catch (e) {}
                    
                    const connected = cfg.apiKey && cfg.enabled;
                    
                    providersHtml.push(`
                        <div class="provider-card glass p-4 rounded-xl cursor-pointer" onclick="app.openProviderModal('${key}')">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="font-bold text-white">${p.name}</div>
                                    <div class="text-xs text-slate-500">${p.type === 'free' ? 'Gratuit' : 'Payant'}</div>
                                </div>
                                <span class="status-dot ${connected ? 'status-connected' : 'status-disconnected'}"></span>
                            </div>
                            ${cfg.role ? `<div class="text-xs text-nexus-400 font-bold uppercase">${cfg.role}</div>` : ''}
                            ${cfg.selectedModel ? `<div class="text-xs text-slate-600 mono mt-1 truncate">${cfg.selectedModel}</div>` : ''}
                        </div>
                    `);
                }
                
                grid.innerHTML = providersHtml.join('');
                lucide.createIcons();
            },

            async openProviderModal(key) {
                app.state.currentProvider = key;
                const p = PROVIDERS[key];
                
                let cfg = {};
                if (csop) {
                    try {
                        const provData = await csop.dispatch('storage.get', { key: `nexus_provider_${key}` });
                        cfg = provData?.data || {};
                    } catch (e) {}
                }
                
                document.getElementById('modal-provider-name').textContent = p.name;
                document.getElementById('modal-api-key').value = cfg.apiKey || '';
                document.getElementById('modal-role').value = cfg.role || '';
                document.getElementById('modal-models').classList.add('hidden');
                
                if (cfg.models && cfg.models.length > 0) {
                    app.renderModels(cfg.models, cfg.selectedModel);
                    document.getElementById('modal-models').classList.remove('hidden');
                }
                
                document.getElementById('provider-modal').classList.remove('hidden');
                document.getElementById('provider-modal').classList.add('flex');
            },

            closeProviderModal() {
                document.getElementById('provider-modal').classList.add('hidden');
                document.getElementById('provider-modal').classList.remove('flex');
            },

            async fetchModels() {
                const key = app.state.currentProvider;
                const p = PROVIDERS[key];
                const apiKey = document.getElementById('modal-api-key').value;
                
                if (!apiKey) return app.toast('Entrez une clé API', 'error');
                
                app.toast('Chargement des modèles...', 'warning');
                
                try {
                    let models = [];
                    
                    if (p.defaultModels) {
                        models = p.defaultModels;
                    } else if (p.modelsEndpoint) {
                        let url = p.modelsEndpoint;
                        let headers = { 'Content-Type': 'application/json' };
                        
                        if (key === 'anthropic') {
                            headers['x-api-key'] = apiKey;
                            headers['anthropic-version'] = '2023-06-01';
                        } else if (key === 'gemini') {
                            url = `${url}?key=${apiKey}`;
                        } else {
                            headers['Authorization'] = `Bearer ${apiKey}`;
                        }
                        
                        if (key === 'openrouter') {
                            headers['HTTP-Referer'] = window.location.href;
                            headers['X-Title'] = 'NEXUS Guardian';
                        }
                        
                        const res = await fetch(url, { headers });
                        if (!res.ok) throw new Error('Échec de connexion');
                        
                        const data = await res.json();
                        
                        if (key === 'groq' || key === 'openai') {
                            models = data.data.map(m => m.id);
                        } else if (key === 'openrouter') {
                            models = data.data.map(m => ({ id: m.id, name: m.name }));
                        } else if (key === 'gemini') {
                            models = data.models.filter(m => m.name.includes('gemini')).map(m => m.name);
                        }
                    }
                    
                    if (csop) {
                        const existing = await csop.dispatch('storage.get', { key: `nexus_provider_${key}` }).catch(() => ({ data: {} }));
                        const provData = existing.data || {};
                        provData.models = models;
                        await csop.dispatch('storage.save', { key: `nexus_provider_${key}`, data: provData });
                    }
                    
                    app.renderModels(models);
                    document.getElementById('modal-models').classList.remove('hidden');
                    app.toast(`✓ ${models.length} modèles chargés`);
                    
                } catch (e) {
                    app.toast('Erreur: ' + e.message, 'error');
                }
            },

            renderModels(models, selectedModel = null) {
                const select = document.getElementById('modal-model-select');
                select.innerHTML = models.map(m => {
                    const id = typeof m === 'string' ? m : m.id;
                    const name = typeof m === 'string' ? m : (m.name || m.id);
                    return `<option value="${id}" ${selectedModel === id ? 'selected' : ''}>${name}</option>`;
                }).join('');
            },

            async saveProvider() {
                const key = app.state.currentProvider;
                const apiKey = document.getElementById('modal-api-key').value;
                const role = document.getElementById('modal-role').value;
                const modelSelect = document.getElementById('modal-model-select');
                const selectedModel = modelSelect.value;
                
                if (!apiKey) return app.toast('Clé API requise', 'error');
                if (!csop) return app.toast('CSOP non initialisé', 'error');
                
                try {
                    const existing = await csop.dispatch('storage.get', { key: `nexus_provider_${key}` }).catch(() => ({ data: {} }));
                    const provData = existing.data || {};
                    
                    provData.apiKey = apiKey;
                    provData.role = role;
                    provData.enabled = role !== '';
                    if (selectedModel) provData.selectedModel = selectedModel;
                    
                    await csop.dispatch('storage.save', { key: `nexus_provider_${key}`, data: provData });
                    
                    if (role === 'lead') {
                        await csop.dispatch('storage.save', {
                            key: 'nexus_lead_provider',
                            data: key
                        });
                    }
                    
                    await app.log('success', `Provider ${key} configuré`, { workflow: 'provider_config', role });
                    await app.renderProviders();
                    await app.updateStats();
                    app.closeProviderModal();
                    app.toast('Provider configuré');
                } catch (e) {
                    app.toast('Erreur sauvegarde', 'error');
                }
            },

            addProviderKey() {
                const providers = Object.keys(PROVIDERS);
                app.openProviderModal(providers[0]);
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>